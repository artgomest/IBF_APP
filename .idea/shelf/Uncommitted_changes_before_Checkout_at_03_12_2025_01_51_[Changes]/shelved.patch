Index: app/src/main/java/com/ibf/app/ui/main/MainActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.ibf.app.ui.main\r\n\r\nimport android.Manifest\r\nimport android.content.Context\r\nimport android.content.Intent\r\nimport android.content.pm.PackageManager\r\nimport android.os.Build\r\nimport android.os.Bundle\r\nimport android.util.Log\r\nimport android.widget.Button\r\nimport android.widget.EditText\r\nimport android.widget.TextView\r\nimport android.widget.Toast\r\nimport androidx.activity.result.contract.ActivityResultContracts\r\nimport androidx.annotation.RequiresApi\r\nimport androidx.appcompat.app.AppCompatActivity\r\nimport androidx.core.content.ContextCompat\r\nimport androidx.core.content.edit\r\nimport com.google.firebase.auth.FirebaseAuth\r\nimport com.google.firebase.firestore.FirebaseFirestore\r\nimport com.google.firebase.firestore.SetOptions\r\nimport com.google.firebase.messaging.FirebaseMessaging\r\nimport com.ibf.app.R\r\nimport com.ibf.app.ui.dashboard.LiderDashboardActivity\r\nimport com.ibf.app.ui.dashboard.PastorDashboardActivity\r\nimport com.ibf.app.ui.dashboard.SecretarioDashboardActivity\r\nimport com.ibf.app.ui.shared.SelecionarPerfilSheet\r\nimport com.ibf.app.ui.usuarios.SolicitacaoCadastroActivity\r\n\r\nclass MainActivity : AppCompatActivity(), SelecionarPerfilSheet.PerfilSelecionadoListener {\r\n\r\n    private lateinit var firebaseAuth: FirebaseAuth\r\n    private lateinit var firestore: FirebaseFirestore\r\n    private lateinit var emailInput: EditText\r\n    private lateinit var passwordInput: EditText\r\n    private lateinit var loginButton: Button\r\n    private lateinit var textCadastreSe: TextView\r\n\r\n    private val requestPermissionLauncher =\r\n        registerForActivityResult(ActivityResultContracts.RequestPermission()) { isGranted: Boolean ->\r\n            if (isGranted) {\r\n                Toast.makeText(this, \"Permissão para notificações concedida!\", Toast.LENGTH_SHORT).show()\r\n            } else {\r\n                Toast.makeText(this, \"Permissão para notificações negada.\", Toast.LENGTH_SHORT).show()\r\n            }\r\n        }\r\n\r\n    override fun onStart() {\r\n        super.onStart()\r\n        // --- CORREÇÃO 1: VERIFICAÇÃO DE SESSÃO ATIVA ---\r\n        val currentUser = firebaseAuth.currentUser\r\n        if (currentUser != null) {\r\n            // Se há um utilizador logado, tenta navegar para o seu último perfil guardado.\r\n            val sharedPref = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val redeSalva = sharedPref.getString(\"REDE_SELECIONADA\", null)\r\n            val papelSalvo = sharedPref.getString(\"PAPEL_SELECIONADO\", null)\r\n\r\n            if (redeSalva != null && papelSalvo != null) {\r\n                navegarParaTelaCorreta(redeSalva, papelSalvo)\r\n            }\r\n            // Se não houver perfil guardado, o utilizador permanecerá na tela de login.\r\n        }\r\n    }\r\n\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        setContentView(R.layout.activity_main)\r\n\r\n        firebaseAuth = FirebaseAuth.getInstance()\r\n        firestore = FirebaseFirestore.getInstance()\r\n\r\n        emailInput = findViewById(R.id.editTextEmailAddress)\r\n        passwordInput = findViewById(R.id.editTextPassword)\r\n        loginButton = findViewById(R.id.buttonLogin)\r\n        textCadastreSe = findViewById(R.id.text_cadastre_se)\r\n\r\n        loginButton.setOnClickListener {\r\n            val email = emailInput.text.toString().trim()\r\n            val password = passwordInput.text.toString().trim()\r\n\r\n            if (email.isEmpty() || password.isEmpty()) {\r\n                Toast.makeText(this, getString(R.string.preencher_todos_campos), Toast.LENGTH_SHORT).show()\r\n                return@setOnClickListener\r\n            }\r\n\r\n            firebaseAuth.signInWithEmailAndPassword(email, password)\r\n                .addOnCompleteListener(this) { task ->\r\n                    if (task.isSuccessful) {\r\n                        task.result?.user?.uid?.let { uid ->\r\n                            salvarTokenDoDispositivo(uid)\r\n                        }\r\n                        processarLogin()\r\n                    } else {\r\n                        Toast.makeText(this, getString(R.string.falha_login_credenciais), Toast.LENGTH_SHORT).show()\r\n                    }\r\n                }\r\n        }\r\n        textCadastreSe.setOnClickListener {\r\n            val intent = Intent(this, SolicitacaoCadastroActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {\r\n            pedirPermissaoDeNotificacao()\r\n        }\r\n    }\r\n\r\n    private fun salvarTokenDoDispositivo(uid: String) {\r\n        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->\r\n            if (!task.isSuccessful) {\r\n                Log.w(\"MainActivity\", \"Falha ao obter token do FCM.\", task.exception)\r\n                return@addOnCompleteListener\r\n            }\r\n            val token = task.result\r\n            val userDocument = firestore.collection(\"usuarios\").document(uid)\r\n            userDocument.set(mapOf(\"fcmToken\" to token), SetOptions.merge())\r\n                .addOnSuccessListener { Log.d(\"MainActivity\", \"Token FCM salvo para o utilizador: $uid\") }\r\n                .addOnFailureListener { e -> Log.e(\"MainActivity\", \"Erro ao salvar token FCM\", e) }\r\n        }\r\n    }\r\n\r\n    private fun processarLogin() {\r\n        val user = firebaseAuth.currentUser ?: return\r\n        firestore.collection(\"usuarios\").document(user.uid).get()\r\n            .addOnSuccessListener { document ->\r\n                if (document != null && document.exists()) {\r\n                    val nomeUsuario = document.getString(\"nome\") ?: getString(R.string.usuario_padrao)\r\n                    @Suppress(\"UNCHECKED_CAST\")\r\n                    val funcoes = document.get(\"funcoes\") as? HashMap<String, String>\r\n\r\n                    if (funcoes.isNullOrEmpty()) {\r\n                        Toast.makeText(this, getString(R.string.usuario_sem_papeis_definidos), Toast.LENGTH_LONG).show()\r\n                        firebaseAuth.signOut()\r\n                        return@addOnSuccessListener\r\n                    }\r\n\r\n                    if (funcoes.size > 1) {\r\n                        val bottomSheet = SelecionarPerfilSheet.newInstance(funcoes, nomeUsuario)\r\n                        bottomSheet.show(supportFragmentManager, \"SelecionarPerfilSheet\")\r\n                    } else {\r\n                        val (rede, papel) = funcoes.entries.first()\r\n                        salvarPerfilSelecionado(rede, papel)\r\n                        navegarParaTelaCorreta(rede, papel)\r\n                    }\r\n                } else {\r\n                    Toast.makeText(this, getString(R.string.dados_usuario_nao_encontrados), Toast.LENGTH_LONG).show()\r\n                    firebaseAuth.signOut()\r\n                }\r\n            }\r\n    }\r\n\r\n    override fun onPerfilSelecionado(rede: String, papel: String) {\r\n        salvarPerfilSelecionado(rede, papel)\r\n        navegarParaTelaCorreta(rede, papel)\r\n    }\r\n\r\n    override fun onLogoutSelecionado() {\r\n        fazerLogout()\r\n    }\r\n\r\n    private fun fazerLogout() {\r\n        firebaseAuth.signOut()\r\n        val sharedPref = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        sharedPref.edit { clear() }\r\n        val intent = Intent(this, MainActivity::class.java)\r\n        intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK\r\n        startActivity(intent)\r\n        finish()\r\n    }\r\n\r\n    // --- CORREÇÃO 3: Função unificada para guardar ambos os dados ---\r\n    private fun salvarPerfilSelecionado(rede: String, papel: String) {\r\n        val sharedPref = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        sharedPref.edit {\r\n            putString(\"REDE_SELECIONADA\", rede)\r\n            putString(\"PAPEL_SELECIONADO\", papel)\r\n        }\r\n    }\r\n\r\n    private fun navegarParaTelaCorreta(rede: String, papel: String?) {\r\n        val intent = when (papel) {\r\n            \"pastor\" -> Intent(this, PastorDashboardActivity::class.java)\r\n            \"lider\" -> Intent(this, LiderDashboardActivity::class.java)\r\n            \"secretario\" -> Intent(this, SecretarioDashboardActivity::class.java)\r\n            else -> null\r\n        }\r\n\r\n        if (intent != null) {\r\n            intent.putExtra(\"REDE_SELECIONADA\", rede)\r\n            intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK\r\n            startActivity(intent)\r\n            finish()\r\n        } else {\r\n            Toast.makeText(this, getString(R.string.papel_desconhecido, papel), Toast.LENGTH_LONG).show()\r\n            firebaseAuth.signOut()\r\n        }\r\n    }\r\n\r\n    @RequiresApi(Build.VERSION_CODES.TIRAMISU)\r\n    private fun pedirPermissaoDeNotificacao() {\r\n        if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) !=\r\n            PackageManager.PERMISSION_GRANTED\r\n        ) {\r\n            requestPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)\r\n        }\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/ibf/app/ui/main/MainActivity.kt b/app/src/main/java/com/ibf/app/ui/main/MainActivity.kt
--- a/app/src/main/java/com/ibf/app/ui/main/MainActivity.kt	(revision 2cde9f49567dcd972fe4fd9ff9100f6323d419ac)
+++ b/app/src/main/java/com/ibf/app/ui/main/MainActivity.kt	(date 1764736926090)
@@ -1,7 +1,6 @@
 package com.ibf.app.ui.main
 
 import android.Manifest
-import android.content.Context
 import android.content.Intent
 import android.content.pm.PackageManager
 import android.os.Build
@@ -47,18 +46,15 @@
 
     override fun onStart() {
         super.onStart()
-        // --- CORREÇÃO 1: VERIFICAÇÃO DE SESSÃO ATIVA ---
         val currentUser = firebaseAuth.currentUser
         if (currentUser != null) {
-            // Se há um utilizador logado, tenta navegar para o seu último perfil guardado.
-            val sharedPref = getSharedPreferences("app_prefs", Context.MODE_PRIVATE)
+            val sharedPref = getSharedPreferences("app_prefs", MODE_PRIVATE)
             val redeSalva = sharedPref.getString("REDE_SELECIONADA", null)
             val papelSalvo = sharedPref.getString("PAPEL_SELECIONADO", null)
 
             if (redeSalva != null && papelSalvo != null) {
                 navegarParaTelaCorreta(redeSalva, papelSalvo)
             }
-            // Se não houver perfil guardado, o utilizador permanecerá na tela de login.
         }
     }
 
@@ -121,20 +117,35 @@
 
     private fun processarLogin() {
         val user = firebaseAuth.currentUser ?: return
+
+        // CORREÇÃO CRÍTICA: Lendo o documento
         firestore.collection("usuarios").document(user.uid).get()
             .addOnSuccessListener { document ->
                 if (document != null && document.exists()) {
                     val nomeUsuario = document.getString("nome") ?: getString(R.string.usuario_padrao)
-                    @Suppress("UNCHECKED_CAST")
-                    val funcoes = document.get("funcoes") as? HashMap<String, String>
+
+                    // 1. LER: Pega os dados como um Map genérico (seguro para qualquer implementação do Android)
+                    val dadosDoBanco = document.get("funcoes") as? Map<*, *>
 
-                    if (funcoes.isNullOrEmpty()) {
+                    // 2. CONVERTER: Cria um NOVO HashMap explícito e copia apenas Strings
+                    // Isso garante que o objeto final seja 100% compatível com Serializable e com o resto do app
+                    val funcoes = HashMap<String, String>()
+                    dadosDoBanco?.forEach { (key, value) ->
+                        if (key is String && value is String) {
+                            funcoes[key] = value
+                        }
+                    }
+
+                    Log.d("DEBUG_LOGIN", "Map convertido com sucesso: $funcoes")
+
+                    if (funcoes.isEmpty()) {
                         Toast.makeText(this, getString(R.string.usuario_sem_papeis_definidos), Toast.LENGTH_LONG).show()
                         firebaseAuth.signOut()
                         return@addOnSuccessListener
                     }
 
                     if (funcoes.size > 1) {
+                        // Agora 'funcoes' é um java.util.HashMap real, que funciona no putSerializable
                         val bottomSheet = SelecionarPerfilSheet.newInstance(funcoes, nomeUsuario)
                         bottomSheet.show(supportFragmentManager, "SelecionarPerfilSheet")
                     } else {
@@ -147,6 +158,10 @@
                     firebaseAuth.signOut()
                 }
             }
+            .addOnFailureListener { e ->
+                Log.e("DEBUG_LOGIN", "Erro ao buscar usuário: ${e.message}")
+                Toast.makeText(this, "Erro de conexão: ${e.message}", Toast.LENGTH_SHORT).show()
+            }
     }
 
     override fun onPerfilSelecionado(rede: String, papel: String) {
@@ -160,7 +175,7 @@
 
     private fun fazerLogout() {
         firebaseAuth.signOut()
-        val sharedPref = getSharedPreferences("app_prefs", Context.MODE_PRIVATE)
+        val sharedPref = getSharedPreferences("app_prefs", MODE_PRIVATE)
         sharedPref.edit { clear() }
         val intent = Intent(this, MainActivity::class.java)
         intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
@@ -168,9 +183,8 @@
         finish()
     }
 
-    // --- CORREÇÃO 3: Função unificada para guardar ambos os dados ---
     private fun salvarPerfilSelecionado(rede: String, papel: String) {
-        val sharedPref = getSharedPreferences("app_prefs", Context.MODE_PRIVATE)
+        val sharedPref = getSharedPreferences("app_prefs", MODE_PRIVATE)
         sharedPref.edit {
             putString("REDE_SELECIONADA", rede)
             putString("PAPEL_SELECIONADO", papel)
Index: settings.gradle.kts
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>// Top-level build file where you can add configuration options common to all sub-projects/modules.\r\npluginManagement {\r\n    repositories {\r\n        google { // Repositório Maven do Google para plugins\r\n            content {\r\n                includeGroupByRegex(\"com\\\\.android.*\")\r\n                includeGroupByRegex(\"com\\\\.google.*\")\r\n                includeGroupByRegex(\"androidx.*\")\r\n            }\r\n        }\r\n        mavenCentral()\r\n        gradlePluginPortal()\r\n    }\r\n}\r\ndependencyResolutionManagement {\r\n    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)\r\n        repositories {\r\n            google() // <--- CORREÇÃO AQUI: Adiciona o repositório Google explicitamente\r\n            mavenCentral()\r\n            maven { url = uri(\"https://jitpack.io\") } // Para MPAndroidChart, por exemplo\r\n        }\r\n}\r\n\r\nrootProject.name = \"IBF APP\"\r\ninclude(\":app\")\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/settings.gradle.kts b/settings.gradle.kts
--- a/settings.gradle.kts	(revision 2cde9f49567dcd972fe4fd9ff9100f6323d419ac)
+++ b/settings.gradle.kts	(date 1764737336298)
@@ -1,13 +1,7 @@
 // Top-level build file where you can add configuration options common to all sub-projects/modules.
 pluginManagement {
     repositories {
-        google { // Repositório Maven do Google para plugins
-            content {
-                includeGroupByRegex("com\\.android.*")
-                includeGroupByRegex("com\\.google.*")
-                includeGroupByRegex("androidx.*")
-            }
-        }
+        google()
         mavenCentral()
         gradlePluginPortal()
     }
@@ -15,7 +9,7 @@
 dependencyResolutionManagement {
     repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
         repositories {
-            google() // <--- CORREÇÃO AQUI: Adiciona o repositório Google explicitamente
+            google()
             mavenCentral()
             maven { url = uri("https://jitpack.io") } // Para MPAndroidChart, por exemplo
         }
Index: .idea/deploymentTargetSelector.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"deploymentTargetSelector\">\r\n    <selectionStates>\r\n      <SelectionState runConfigName=\"app\">\r\n        <option name=\"selectionMode\" value=\"DROPDOWN\" />\r\n        <DropdownSelection timestamp=\"2025-06-27T02:29:01.108470Z\">\r\n          <Target type=\"DEFAULT_BOOT\">\r\n            <handle>\r\n              <DeviceId pluginId=\"Default\" identifier=\"serial=192.168.1.5:37425;connection=5cc14fee\" />\r\n            </handle>\r\n          </Target>\r\n        </DropdownSelection>\r\n        <DialogSelection>\r\n          <targets>\r\n            <Target type=\"DEFAULT_BOOT\">\r\n              <handle>\r\n                <DeviceId pluginId=\"PhysicalDevice\" identifier=\"serial=RQCW40608ZD\" />\r\n              </handle>\r\n            </Target>\r\n          </targets>\r\n        </DialogSelection>\r\n      </SelectionState>\r\n      <SelectionState runConfigName=\"LiderStatusRelatoriosActivity\">\r\n        <option name=\"selectionMode\" value=\"DROPDOWN\" />\r\n      </SelectionState>\r\n    </selectionStates>\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/deploymentTargetSelector.xml b/.idea/deploymentTargetSelector.xml
--- a/.idea/deploymentTargetSelector.xml	(revision 2cde9f49567dcd972fe4fd9ff9100f6323d419ac)
+++ b/.idea/deploymentTargetSelector.xml	(date 1764737385084)
@@ -4,25 +4,14 @@
     <selectionStates>
       <SelectionState runConfigName="app">
         <option name="selectionMode" value="DROPDOWN" />
-        <DropdownSelection timestamp="2025-06-27T02:29:01.108470Z">
+        <DropdownSelection timestamp="2025-12-03T04:49:22.620965200Z">
           <Target type="DEFAULT_BOOT">
             <handle>
-              <DeviceId pluginId="Default" identifier="serial=192.168.1.5:37425;connection=5cc14fee" />
-            </handle>
-          </Target>
-        </DropdownSelection>
-        <DialogSelection>
-          <targets>
-            <Target type="DEFAULT_BOOT">
-              <handle>
-                <DeviceId pluginId="PhysicalDevice" identifier="serial=RQCW40608ZD" />
-              </handle>
-            </Target>
-          </targets>
-        </DialogSelection>
-      </SelectionState>
-      <SelectionState runConfigName="LiderStatusRelatoriosActivity">
-        <option name="selectionMode" value="DROPDOWN" />
+              <DeviceId pluginId="PhysicalDevice" identifier="serial=RQCW40608ZD" />
+            </handle>
+          </Target>
+        </DropdownSelection>
+        <DialogSelection />
       </SelectionState>
     </selectionStates>
   </component>
